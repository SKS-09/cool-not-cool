import { createHmac } from 'crypto'; const NAME='cn_sess'; const KEY=process.env.SESSION_SECRET||'dev_secret';
export function setSessionCookie(resHeaders:Headers,payload:any){const data=Buffer.from(JSON.stringify(payload)).toString('base64url'); const sig=createHmac('sha256',KEY).update(data).digest('base64url'); const cookie=`${NAME}=${data}.${sig}; Path=/; HttpOnly; SameSite=Lax; Max-Age=2592000`; resHeaders.append('Set-Cookie',cookie);}
export function getSessionCookie(req:Request):any|null{const cookie=req.headers.get('cookie')||''; const m=cookie.match(new RegExp(`${NAME}=([^;]+)`)); if(!m) return null; const [data,sig]=m[1].split('.'); const exp=createHmac('sha256',KEY).update(data).digest('base64url'); if(sig!==exp) return null; try{return JSON.parse(Buffer.from(data,'base64url').toString());}catch{return null;} }